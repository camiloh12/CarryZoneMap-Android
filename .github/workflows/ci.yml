name: Android CI

on:
  pull_request:
    branches:
      - develop
      - master

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create local.properties
      run: |
        cat > local.properties << EOF
        # Supabase configuration (required)
        SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

        # MapTiler API key (optional - demo tiles work without it)
        MAPTILER_API_KEY=${{ secrets.MAPTILER_API_KEY }}
        EOF

    - name: Build debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Run unit tests
      run: ./gradlew test --stacktrace

    - name: Run Android Lint
      run: ./gradlew lint --stacktrace

    - name: Run Detekt
      run: ./gradlew detekt --stacktrace

    - name: Run KtLint
      run: ./gradlew ktlintCheck --stacktrace

    - name: Upload test reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          app/build/reports/tests/**/*
          app/build/reports/lint-results*.html
          app/build/reports/detekt/**/*
          app/build/reports/ktlint/**/*
        retention-days: 7

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7

    - name: Generate job summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Build:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

        if [ -f app/build/reports/tests/testDebugUnitTest/index.html ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports available in artifacts" >> $GITHUB_STEP_SUMMARY
        fi
